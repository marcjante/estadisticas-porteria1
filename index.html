<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Estadísticas Completas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js para gráficas (solo para PDF) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #333;
            min-height: 100vh;
            padding: 10px;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: rgba(255, 255, 255, 0.98);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(to right, #2c3e50, #4a6491);
            color: white;
            padding: 15px 10px;
            text-align: center;
        }
        
        h1 {
            font-size: 1.4rem;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .content {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }
        
        .section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        
        .section-title {
            font-size: 1.1rem;
            color: #2c3e50;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .section-title i {
            color: #3498db;
        }
        
        /* Contenedor de las dos porterías */
        .goals-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        @media (min-width: 768px) {
            .goals-container {
                flex-direction: row;
            }
            
            .goal-section {
                flex: 1;
            }
        }
        
        /* Secciones de portería */
        .goal-section {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            border: 1px solid #ddd;
        }
        
        .goal-section.defense {
            border-top: 4px solid #3498db;
        }
        
        .goal-section.attack {
            border-top: 4px solid #059669;
        }
        
        .goal-section-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .goal-section-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .goal-section-title.defense {
            color: #3498db;
        }
        
        .goal-section-title.attack {
            color: #059669;
        }
        
        /* Estilos para la portería visual */
        .goal-visual-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .goal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 5px;
            width: 200px;
            height: 200px;
            margin: 0 auto 15px;
            border: 6px solid #2c3e50;
            border-radius: 3px;
            background-color: #34495e;
            position: relative;
        }
        
        @media (min-width: 768px) {
            .goal-grid {
                width: 220px;
                height: 220px;
            }
        }
        
        .goal-grid::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(to bottom, transparent 30%, rgba(0, 0, 0, 0.1) 30%, rgba(0, 0, 0, 0.1) 70%, transparent 70%);
            pointer-events: none;
        }
        
        .goal-zone {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #95a5a6;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .goal-zone:hover {
            transform: scale(1.02);
            box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
        }
        
        .goal-zone.active-goal {
            background-color: rgba(220, 38, 38, 0.5);
            border: 2px solid #dc2626;
        }
        
        .goal-zone.active-save {
            background-color: rgba(5, 150, 105, 0.5);
            border: 2px solid #059669;
        }
        
        .goal-zone.active-miss {
            background-color: rgba(245, 158, 11, 0.5);
            border: 2px solid #f59e0b;
        }
        
        .zone-stats {
            font-size: 0.8rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .zone-label {
            font-size: 0.6rem;
            color: #7f8c8d;
            margin-top: 2px;
        }
        
        /* Botones de zona */
        .zone-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .zone-btn {
            padding: 5px 8px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
            font-size: 0.75rem;
        }
        
        .zone-btn:hover {
            background-color: #2980b9;
        }
        
        .zone-btn.active {
            background-color: #2c3e50;
            box-shadow: 0 3px 5px rgba(0, 0, 0, 0.2);
        }
        
        /* Botón para "Fuera de portería" */
        .outside-btn {
            padding: 8px 12px;
            background-color: #f59e0b;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 0.75rem;
            margin: 5px auto;
            width: fit-content;
        }
        
        .outside-btn:hover {
            background-color: #d97706;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        .outside-info {
            text-align: center;
            font-size: 0.7rem;
            color: #f59e0b;
            margin-top: 5px;
            font-weight: bold;
        }
        
        /* Controles */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            margin-bottom: 15px;
        }
        
        .control-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
            font-size: 0.75rem;
            flex: 1;
            min-width: 100px;
            justify-content: center;
        }
        
        .goal-btn {
            background-color: #dc2626;
            color: white;
        }
        
        .save-btn {
            background-color: #059669;
            color: white;
        }
        
        .miss-btn {
            background-color: #f59e0b;
            color: white;
        }
        
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Selector de jugador */
        .player-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .player-selector-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: 100%;
        }
        
        .player-input-container {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .player-input {
            width: 70px;
            padding: 6px 10px;
            border: 2px solid #059669;
            border-radius: 6px;
            font-size: 1rem;
            text-align: center;
            font-weight: bold;
        }
        
        .add-player-btn {
            padding: 6px 12px;
            background-color: #059669;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            font-size: 0.8rem;
        }
        
        .add-player-btn:hover {
            background-color: #047857;
        }
        
        .player-buttons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }
        
        .player-btn {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #e0e0e0;
            border: 2px solid #ccc;
            color: #333;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 0.85rem;
        }
        
        .player-btn:hover {
            transform: scale(1.1);
        }
        
        .player-btn.active {
            background-color: #059669;
            border-color: #047857;
            color: white;
            box-shadow: 0 3px 6px rgba(5, 150, 105, 0.3);
        }
        
        .player-btn.goal {
            background-color: #dc2626;
            border-color: #b91c1c;
            color: white;
        }
        
        .player-btn.save {
            background-color: #059669;
            border-color: #047857;
            color: white;
        }
        
        .player-btn.miss {
            background-color: #f59e0b;
            border-color: #d97706;
            color: white;
        }
        
        /* Estadísticas */
        .stats-container {
            background-color: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }
        
        .stat-card {
            background-color: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        }
        
        .stat-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            font-size: 0.7rem;
            color: #7f8c8d;
            margin-top: 3px;
        }
        
        /* Indicadores de selección */
        .selection-info {
            text-align: center;
            font-size: 0.85rem;
            color: #2c3e50;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 6px;
            background-color: #f0f7ff;
        }
        
        .selection-info.defense {
            border-left: 4px solid #3498db;
        }
        
        .selection-info.attack {
            border-left: 4px solid #059669;
        }
        
        /* Eventos */
        #events-list {
            height: 150px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            background-color: white;
            margin-top: 10px;
            font-size: 0.75rem;
        }
        
        .event-item {
            padding: 6px;
            margin-bottom: 5px;
            border-radius: 4px;
            background-color: #f8f9fa;
            font-size: 0.75rem;
        }
        
        /* Controles globales */
        .global-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }
        
        .global-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            flex: 1;
            min-width: 140px;
            justify-content: center;
        }
        
        .reset-btn {
            background-color: #6b7280;
            color: white;
        }
        
        .pdf-btn {
            background-color: #7c3aed;
            color: white;
        }
        
        .email-btn {
            background-color: #ea580c;
            color: white;
        }
        
        .global-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        
        /* Modal para email */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #2c3e50;
            font-weight: bold;
        }
        
        .form-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.2s;
        }
        
        .form-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .modal-btn.cancel {
            background-color: #6b7280;
            color: white;
        }
        
        .modal-btn.send {
            background-color: #059669;
            color: white;
        }
        
        /* Tabla de estadísticas de jugadores */
        .players-stats-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 0.75rem;
        }
        
        .players-stats-table th {
            background-color: #059669;
            color: white;
            padding: 8px;
            text-align: center;
        }
        
        .players-stats-table td {
            padding: 6px;
            text-align: center;
            border-bottom: 1px solid #ddd;
        }
        
        .players-stats-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        /* Ocultar sección de gráficas en web */
        .charts-section {
            display: none;
        }
        
        /* Previsualización PDF */
        .pdf-preview {
            display: none;
            margin-top: 15px;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 2px dashed #7c3aed;
        }
        
        .pdf-preview h3 {
            color: #7c3aed;
            margin-bottom: 10px;
        }
        
        .pdf-preview iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        footer {
            text-align: center;
            padding: 15px 10px;
            color: #7f8c8d;
            font-size: 0.7rem;
            border-top: 1px solid #eee;
            margin-top: 15px;
        }
        
        /* Scroll personalizado */
        ::-webkit-scrollbar {
            width: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-futbol"></i> Estadísticas Completas</h1>
            <p class="subtitle">Defensa (Portero) y Ataque (Jugadores)</p>
        </header>
        
        <div class="content">
            <!-- Contenedor de las dos porterías -->
            <div class="goals-container">
                <!-- Portería de DEFENSA (Portero) -->
                <div class="goal-section defense">
                    <div class="goal-section-header">
                        <i class="fas fa-shield-alt" style="color: #3498db; font-size: 1.2rem;"></i>
                        <div class="goal-section-title defense">PORTERO</div>
                    </div>
                    
                    <div class="goal-visual-container">
                        <div id="goal-grid-defense" class="goal-grid">
                            <!-- Las zonas de portería se generarán con JavaScript -->
                        </div>
                        
                        <div id="zone-buttons-defense" class="zone-buttons">
                            <!-- Los botones de zona se generarán con JavaScript -->
                        </div>
                        
                        <button id="outside-btn-defense" class="outside-btn">
                            <i class="fas fa-external-link-alt"></i> Tiro Fuera de Portería
                        </button>
                        <div class="outside-info">Registra tiros que NO entran en la portería</div>
                        
                        <div id="selection-info-defense" class="selection-info defense">
                            Selecciona una zona para registrar acción del portero
                        </div>
                        
                        <div class="controls">
                            <button id="save-btn-defense" class="control-btn save-btn">
                                <i class="fas fa-hand-paper"></i> Parada
                            </button>
                            <button id="goal-btn-defense" class="control-btn goal-btn">
                                <i class="fas fa-bullseye"></i> Gol
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Portería de ATAQUE (Jugadores) -->
                <div class="goal-section attack">
                    <div class="goal-section-header">
                        <i class="fas fa-bullseye" style="color: #059669; font-size: 1.2rem;"></i>
                        <div class="goal-section-title attack">JUGADORES</div>
                    </div>
                    
                    <div class="goal-visual-container">
                        <div id="goal-grid-attack" class="goal-grid">
                            <!-- Las zonas de portería se generarán con JavaScript -->
                        </div>
                        
                        <div id="zone-buttons-attack" class="zone-buttons">
                            <!-- Los botones de zona se generarán con JavaScript -->
                        </div>
                        
                        <button id="outside-btn-attack" class="outside-btn">
                            <i class="fas fa-external-link-alt"></i> Tiro Fuera de Portería
                        </button>
                        <div class="outside-info">Registra tiros que NO entran en la portería</div>
                        
                        <!-- Selector de jugadores -->
                        <div class="player-selector">
                            <div class="player-selector-container">
                                <div class="player-input-container">
                                    <input type="number" id="player-number-input" class="player-input" placeholder="Nº" min="1" max="99">
                                    <button id="add-player-btn" class="add-player-btn">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                                
                                <div class="player-buttons-container" id="player-buttons-container">
                                    <!-- Los botones de jugadores se agregarán dinámicamente -->
                                </div>
                                
                                <div style="text-align: center; font-size: 0.7rem; color: #7f8c8d;">
                                    Máximo 8 jugadores. Haz clic para seleccionar.
                                </div>
                            </div>
                        </div>
                        
                        <div id="selection-info-attack" class="selection-info attack">
                            Selecciona un jugador y una zona para registrar tiro
                        </div>
                        
                        <div class="controls">
                            <button id="goal-btn-attack" class="control-btn goal-btn">
                                <i class="fas fa-bullseye"></i> Gol
                            </button>
                            <button id="save-btn-attack" class="control-btn save-btn">
                                <i class="fas fa-hand-paper"></i> Parado
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Controles globales -->
            <div class="global-controls">
                <button id="reset-btn" class="global-btn reset-btn">
                    <i class="fas fa-undo"></i> Reset Zona
                </button>
                <button id="pdf-btn" class="global-btn pdf-btn">
                    <i class="fas fa-file-pdf"></i> Generar PDF
                </button>
                <button id="email-btn" class="global-btn email-btn">
                    <i class="fas fa-paper-plane"></i> Enviar por Email
                </button>
            </div>
            
            <!-- Previsualización PDF (Opcional) -->
            <div id="pdf-preview" class="pdf-preview">
                <h3><i class="fas fa-eye"></i> Vista Previa del PDF</h3>
                <iframe id="pdf-viewer" src="" style="display: none;"></iframe>
                <div id="pdf-info">
                    <p>PDF generado exitosamente. Haz clic en "Descargar PDF" para guardarlo o "Enviar por Email" para compartirlo.</p>
                    <div class="global-controls" style="margin-top: 10px;">
                        <button id="download-pdf-btn" class="global-btn pdf-btn">
                            <i class="fas fa-download"></i> Descargar PDF
                        </button>
                        <button id="share-pdf-btn" class="global-btn email-btn">
                            <i class="fas fa-share-alt"></i> Compartir
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Estadísticas -->
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-chart-bar"></i> Estadísticas
                </div>
                
                <div class="stats-container">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-saves">0</div>
                            <div class="stat-label">Paradas Portero</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-goals-defense">0</div>
                            <div class="stat-label">Goles Recibidos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="total-misses">0</div>
                            <div class="stat-label">Tiros Fuera</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="effectiveness">0%</div>
                            <div class="stat-label">Efectividad Portero</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sección de Eventos -->
            <div class="section">
                <div class="section-title">
                    <i class="fas fa-list-alt"></i> Eventos del Partido
                </div>
                
                <div id="events-list">
                    <!-- Los eventos se agregarán con JavaScript -->
                </div>
            </div>
            
            <!-- Sección de Estadísticas de Jugadores -->
            <div class="section" id="players-stats-section">
                <div class="section-title">
                    <i class="fas fa-users"></i> Estadísticas por Jugador 
                </div>
                
                <div class="stats-container">
                    <table class="players-stats-table">
                        <thead>
                            <tr>
                                <th>Jugador</th>
                                <th>Tiros</th>
                                <th>Goles</th>
                                <th>Parados</th>
                                <th>Fuera</th>
                                <th>% Acierto</th>
                            </tr>
                        </thead>
                        <tbody id="players-stats-body">
                            <!-- Las filas se generarán con JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Sección de Gráficas (OCULTA en web, visible solo en PDF) -->
            <div class="section charts-section">
                <div class="section-title">
                    <i class="fas fa-chart-pie"></i> Gráficas de Estadísticas 
                </div>
                
                <!-- Contenedores para gráficas que se usarán en PDF -->
                <div id="pdf-charts" style="display: none;">
                    <canvas id="shotsChartPDF"></canvas>
                    <canvas id="zoneEffectivenessChartPDF"></canvas>
                    <canvas id="playersChartPDF"></canvas>
                    <canvas id="heatmapChartPDF"></canvas>
                </div>
            </div>
        </div>
        
        <footer>
            <p>Hoquei Palau Solita i Plegamants</p>
        </footer>
    </div>

    <!-- Modal para enviar por email -->
    <div id="email-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">
                <i class="fas fa-paper-plane"></i> Enviar Estadísticas por Email
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email-to">Email Destinatario:</label>
                <input type="email" id="email-to" class="form-input" placeholder="ejemplo@correo.com" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email-subject">Asunto:</label>
                <input type="text" id="email-subject" class="form-input" value="Estadísticas de Portería - Reporte" required>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="email-message">Mensaje:</label>
                <textarea id="email-message" class="form-input" rows="4" placeholder="Mensaje opcional..."></textarea>
            </div>
            
            <div class="modal-buttons">
                <button id="cancel-email-btn" class="modal-btn cancel">Cancelar</button>
                <button id="send-email-btn" class="modal-btn send">Enviar Email</button>
            </div>
        </div>
    </div>

    <!-- Incluir jsPDF para generación de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Incluir html2canvas para capturar elementos HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        // ---------- VARIABLES GLOBALES ----------
        const state = {
            // Para defensa
            defenseSelectedZone: null,
            
            // Para ataque
            attackSelectedZone: null,
            selectedPlayer: null,
            
            // Estadísticas del portero (defensa)
            goalkeeperStats: {
                totalSaves: 0,
                totalGoals: 0,
                totalMisses: 0,
                zones: {
                    'A1': { saves: 0, goals: 0 },
                    'A2': { saves: 0, goals: 0 },
                    'A3': { saves: 0, goals: 0 },
                    'B1': { saves: 0, goals: 0 },
                    'B2': { saves: 0, goals: 0 },
                    'B3': { saves: 0, goals: 0 },
                    'C1': { saves: 0, goals: 0 },
                    'C2': { saves: 0, goals: 0 },
                    'C3': { saves: 0, goals: 0 }
                }
            },
            
            // Estadísticas de atacantes
            attackersStats: {
                players: {}, // Se llenará dinámicamente
                zones: {
                    'A1': { shots: 0, goals: 0 },
                    'A2': { shots: 0, goals: 0 },
                    'A3': { shots: 0, goals: 0 },
                    'B1': { shots: 0, goals: 0 },
                    'B2': { shots: 0, goals: 0 },
                    'B3': { shots: 0, goals: 0 },
                    'C1': { shots: 0, goals: 0 },
                    'C2': { shots: 0, goals: 0 },
                    'C3': { shots: 0, goals: 0 }
                }
            },
            
            events: [],
            playerNumbers: [], // Para almacenar los números de jugadores agregados
            
            // Variables para PDF
            lastGeneratedPDF: null,
            pdfBlob: null
        };

        // ---------- FUNCIONES UTILITARIAS ----------
        function $(id) {
            return document.getElementById(id);
        }

        function addEventMessage(message) {
            const eventsList = $("events-list");
            const msgDiv = document.createElement("div");
            msgDiv.className = "event-item";
            msgDiv.innerHTML = message;
            eventsList.appendChild(msgDiv);
            eventsList.scrollTop = eventsList.scrollHeight;
        }

        function getCurrentTime() {
            const now = new Date();
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${now.getHours()}:${minutes}`;
        }

        // ---------- CREAR PORTERÍAS VISUALES ----------
        function createGoalVisuals() {
            createGoalVisual('defense');
            createGoalVisual('attack');
        }
        
        function createGoalVisual(mode) {
            const goalGrid = $(`goal-grid-${mode}`);
            const zoneButtons = $(`zone-buttons-${mode}`);
            
            goalGrid.innerHTML = "";
            zoneButtons.innerHTML = "";
            
            const zones = ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3'];
            
            zones.forEach(zone => {
                // Crear zona en la portería visual
                const zoneDiv = document.createElement("div");
                zoneDiv.className = "goal-zone";
                zoneDiv.dataset.zone = zone;
                zoneDiv.dataset.mode = mode;
                zoneDiv.id = `zone-${mode}-${zone}`;
                
                const zoneStats = document.createElement("div");
                zoneStats.className = "zone-stats";
                zoneStats.id = `zone-stats-${mode}-${zone}`;
                zoneStats.textContent = "0-0";
                
                const zoneLabel = document.createElement("div");
                zoneLabel.className = "zone-label";
                zoneLabel.textContent = zone;
                
                zoneDiv.appendChild(zoneStats);
                zoneDiv.appendChild(zoneLabel);
                
                zoneDiv.addEventListener("click", () => selectZone(mode, zone));
                goalGrid.appendChild(zoneDiv);
                
                // Crear botón de zona
                const zoneBtn = document.createElement("button");
                zoneBtn.className = "zone-btn";
                zoneBtn.dataset.zone = zone;
                zoneBtn.dataset.mode = mode;
                zoneBtn.textContent = zone;
                zoneBtn.addEventListener("click", () => selectZone(mode, zone));
                zoneButtons.appendChild(zoneBtn);
            });
            
            updateZoneStats(mode);
        }
        
        function selectZone(mode, zone) {
            if (mode === 'defense') {
                if (state.defenseSelectedZone) {
                    const prevZone = document.querySelector(`#zone-defense-${state.defenseSelectedZone}`);
                    const prevBtn = document.querySelector(`.zone-btn[data-mode="defense"][data-zone="${state.defenseSelectedZone}"]`);
                    if (prevZone) prevZone.classList.remove('active-goal', 'active-save', 'active-miss');
                    if (prevBtn) prevBtn.classList.remove('active');
                }
                
                state.defenseSelectedZone = zone;
                $("selection-info-defense").textContent = `Zona ${zone} seleccionada para defensa`;
                
            } else if (mode === 'attack') {
                if (state.attackSelectedZone) {
                    const prevZone = document.querySelector(`#zone-attack-${state.attackSelectedZone}`);
                    const prevBtn = document.querySelector(`.zone-btn[data-mode="attack"][data-zone="${state.attackSelectedZone}"]`);
                    if (prevZone) prevZone.classList.remove('active-goal', 'active-save', 'active-miss');
                    if (prevBtn) prevBtn.classList.remove('active');
                }
                
                state.attackSelectedZone = zone;
                $("selection-info-attack").textContent = state.selectedPlayer 
                    ? `Zona ${zone} | Jugador ${state.selectedPlayer} seleccionado`
                    : `Zona ${zone} seleccionada | Selecciona un jugador`;
            }
            
            const zoneDiv = document.querySelector(`#zone-${mode}-${zone}`);
            const zoneBtn = document.querySelector(`.zone-btn[data-mode="${mode}"][data-zone="${zone}"]`);
            
            if (zoneBtn) zoneBtn.classList.add('active');
        }
        
        function updateZoneStats(mode) {
            const zones = mode === 'defense' ? state.goalkeeperStats.zones : state.attackersStats.zones;
            
            for (const zone in zones) {
                const stats = zones[zone];
                const zoneStats = document.getElementById(`zone-stats-${mode}-${zone}`);
                
                if (zoneStats) {
                    zoneStats.textContent = mode === 'defense' 
                        ? `${stats.saves}-${stats.goals}`
                        : `${stats.shots}-${stats.goals}`;
                }
            }
        }
        
        // ---------- GESTIÓN DE JUGADORES ----------
        function addPlayer() {
            const input = $("player-number-input");
            const playerNumber = input.value.trim();
            
            if (!playerNumber) {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Introduce un número de jugador</span>`);
                return;
            }
            
            if (state.playerNumbers.includes(playerNumber)) {
                addEventMessage(`<span style="color: #f59e0b"><i class="fas fa-exclamation-triangle"></i> El jugador ${playerNumber} ya está agregado</span>`);
                input.value = "";
                return;
            }
            
            if (state.playerNumbers.length >= 8) {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Máximo 8 jugadores permitidos</span>`);
                return;
            }
            
            state.playerNumbers.push(playerNumber);
            
            if (!state.attackersStats.players[playerNumber]) {
                state.attackersStats.players[playerNumber] = {
                    shots: 0,
                    goals: 0,
                    saves: 0,
                    misses: 0,
                    name: `Jugador ${playerNumber}`
                };
            }
            
            createPlayerButton(playerNumber);
            input.value = "";
            addEventMessage(`<span style="color: #059669"><i class="fas fa-check-circle"></i> Jugador ${playerNumber} agregado</span>`);
            selectPlayer(playerNumber);
            updatePlayerStats();
        }
        
        function createPlayerButton(playerNumber) {
            const container = $("player-buttons-container");
            
            if (document.querySelector(`.player-btn[data-player="${playerNumber}"]`)) return;
            
            const playerBtn = document.createElement("button");
            playerBtn.className = "player-btn";
            playerBtn.dataset.player = playerNumber;
            playerBtn.textContent = playerNumber;
            playerBtn.addEventListener("click", () => selectPlayer(playerNumber));
            container.appendChild(playerBtn);
        }
        
        function selectPlayer(playerNumber) {
            if (state.selectedPlayer) {
                const prevPlayerBtn = document.querySelector(`.player-btn[data-player="${state.selectedPlayer}"]`);
                if (prevPlayerBtn) prevPlayerBtn.classList.remove('active');
            }
            
            state.selectedPlayer = playerNumber;
            const playerBtn = document.querySelector(`.player-btn[data-player="${playerNumber}"]`);
            
            if (playerBtn) playerBtn.classList.add('active');
            
            $("selection-info-attack").textContent = state.attackSelectedZone 
                ? `Zona ${state.attackSelectedZone} | Jugador ${playerNumber} seleccionado`
                : `Jugador ${playerNumber} seleccionado | Selecciona una zona`;
            
            addEventMessage(`<span style="color: #059669"><i class="fas fa-user-check"></i> Jugador ${playerNumber} seleccionado para ataque</span>`);
        }
        
        function updatePlayerStats() {
            const statsBody = $("players-stats-body");
            if (!statsBody) return;
            
            statsBody.innerHTML = "";
            
            const playerIds = state.playerNumbers.sort((a, b) => {
                const numA = parseInt(a) || 0;
                const numB = parseInt(b) || 0;
                return numA - numB;
            });
            
            playerIds.forEach(playerId => {
                const playerStats = state.attackersStats.players[playerId];
                if (!playerStats) return;
                
                const totalShots = playerStats.shots;
                const goals = playerStats.goals;
                const saves = playerStats.saves;
                const misses = playerStats.misses;
                const accuracy = totalShots > 0 ? Math.round((goals / totalShots) * 100) : 0;
                
                const row = document.createElement("tr");
                
                let playerClass = "";
                if (playerStats.shots > 0) {
                    if (accuracy >= 50) playerClass = "goal";
                    else if (accuracy >= 30) playerClass = "save";
                    else playerClass = "miss";
                }
                
                row.innerHTML = `
                    <td><span class="player-btn ${playerClass}" style="width:30px;height:30px;display:inline-flex;align-items:center;justify-content:center;">${playerId}</span></td>
                    <td>${totalShots}</td>
                    <td>${goals}</td>
                    <td>${saves}</td>
                    <td>${misses}</td>
                    <td>${accuracy}%</td>
                `;
                
                statsBody.appendChild(row);
            });
        }
        
        // ---------- REGISTRO DE ACCIONES ----------
        function registerDefenseAction(actionType) {
            if (!state.defenseSelectedZone && actionType !== 'miss') {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Selecciona una zona en la portería de defensa</span>`);
                return;
            }
            
            const time = getCurrentTime();
            
            if (actionType === 'miss') {
                state.goalkeeperStats.totalMisses++;
                
                const actionText = `Tiro fuera del portero`;
                state.events.push({
                    time,
                    playerName: "Portero",
                    type: actionText,
                    zone: 'FUERA',
                    actionType: actionType,
                    mode: 'defense'
                });
                
                updateGoalkeeperStats();
                addEventMessage(`<span style="color: #f59e0b"><i class="fas fa-external-link-alt"></i> [${time}] ${actionText}</span>`);
                return;
            }
            
            const zone = state.defenseSelectedZone;
            
            if (actionType === 'save') {
                state.goalkeeperStats.zones[zone].saves++;
                state.goalkeeperStats.totalSaves++;
            } else if (actionType === 'goal') {
                state.goalkeeperStats.zones[zone].goals++;
                state.goalkeeperStats.totalGoals++;
            }
            
            const zoneDiv = document.querySelector(`#zone-defense-${zone}`);
            if (zoneDiv) {
                zoneDiv.classList.remove('active-goal', 'active-save', 'active-miss');
                zoneDiv.classList.add(`active-${actionType}`);
            }
            
            let actionText = '', icon = '', color = '';
            if (actionType === 'save') {
                actionText = `Parada del portero en zona ${zone}`;
                icon = 'hand-paper';
                color = '#059669';
            } else if (actionType === 'goal') {
                actionText = `Gol recibido en zona ${zone}`;
                icon = 'bullseye';
                color = '#dc2626';
            }
            
            state.events.push({
                time,
                playerName: "Portero",
                type: actionText,
                zone: zone,
                actionType: actionType,
                mode: 'defense'
            });
            
            updateZoneStats('defense');
            updateGoalkeeperStats();
            addEventMessage(`<span style="color: ${color}"><i class="fas fa-${icon}"></i> [${time}] ${actionText}</span>`);
        }
        
        function registerAttackAction(actionType) {
            if (actionType === 'miss') {
                if (!state.selectedPlayer) {
                    addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Selecciona un jugador para registrar tiro fuera</span>`);
                    return;
                }
                
                const time = getCurrentTime();
                const playerId = state.selectedPlayer;
                const playerStats = state.attackersStats.players[playerId];
                
                playerStats.shots++;
                playerStats.misses++;
                
                const actionText = `Tiro fuera de Jugador ${playerId}`;
                state.events.push({
                    time,
                    playerName: `Jugador ${playerId}`,
                    type: actionText,
                    zone: 'FUERA',
                    actionType: actionType,
                    mode: 'attack'
                });
                
                updatePlayerStats();
                
                const playerBtn = document.querySelector(`.player-btn[data-player="${playerId}"]`);
                if (playerBtn) {
                    playerBtn.classList.remove('goal', 'save', 'miss');
                    playerBtn.classList.add(actionType);
                }
                
                addEventMessage(`<span style="color: #f59e0b"><i class="fas fa-external-link-alt"></i> [${time}] ${actionText}</span>`);
                return;
            }
            
            if (!state.attackSelectedZone) {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Selecciona una zona en la portería de ataque</span>`);
                return;
            }
            
            if (!state.selectedPlayer) {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Selecciona un jugador para registrar ataque</span>`);
                return;
            }
            
            const time = getCurrentTime();
            const zone = state.attackSelectedZone;
            const playerId = state.selectedPlayer;
            const playerStats = state.attackersStats.players[playerId];
            
            playerStats.shots++;
            
            if (actionType === 'goal') {
                playerStats.goals++;
                state.attackersStats.zones[zone].goals++;
                state.attackersStats.zones[zone].shots++;
            } else if (actionType === 'save') {
                playerStats.saves++;
                state.attackersStats.zones[zone].shots++;
            }
            
            const zoneDiv = document.querySelector(`#zone-attack-${zone}`);
            if (zoneDiv) {
                zoneDiv.classList.remove('active-goal', 'active-save', 'active-miss');
                zoneDiv.classList.add(`active-${actionType}`);
            }
            
            let actionText = '', icon = '', color = '';
            if (actionType === 'goal') {
                actionText = `Gol de Jugador ${playerId} en zona ${zone}`;
                icon = 'bullseye';
                color = '#dc2626';
            } else if (actionType === 'save') {
                actionText = `Tiro de Jugador ${playerId} parado en zona ${zone}`;
                icon = 'hand-paper';
                color = '#059669';
            }
            
            state.events.push({
                time,
                playerName: `Jugador ${playerId}`,
                type: actionText,
                zone: zone,
                actionType: actionType,
                mode: 'attack'
            });
            
            updateZoneStats('attack');
            updatePlayerStats();
            
            const playerBtn = document.querySelector(`.player-btn[data-player="${playerId}"]`);
            if (playerBtn) {
                playerBtn.classList.remove('goal', 'save', 'miss');
                playerBtn.classList.add(actionType);
            }
            
            addEventMessage(`<span style="color: ${color}"><i class="fas fa-${icon}"></i> [${time}] ${actionText}</span>`);
        }
        
        function updateGoalkeeperStats() {
            const stats = state.goalkeeperStats;
            
            $("total-saves").textContent = stats.totalSaves;
            $("total-goals-defense").textContent = stats.totalGoals;
            $("total-misses").textContent = stats.totalMisses;
            
            const totalShots = stats.totalSaves + stats.totalGoals;
            const effectiveness = totalShots > 0 ? Math.round((stats.totalSaves / totalShots) * 100) : 0;
            $("effectiveness").textContent = `${effectiveness}%`;
        }
        
        function resetZoneAction() {
            let zoneToReset = null;
            let modeToReset = null;
            
            if (state.defenseSelectedZone) {
                zoneToReset = state.defenseSelectedZone;
                modeToReset = 'defense';
            } else if (state.attackSelectedZone) {
                zoneToReset = state.attackSelectedZone;
                modeToReset = 'attack';
            } else {
                addEventMessage(`<span style="color: #dc2626"><i class="fas fa-exclamation-circle"></i> Error: Selecciona una zona para resetear</span>`);
                return;
            }
            
            for (let i = state.events.length - 1; i >= 0; i--) {
                if (state.events[i].zone === zoneToReset && 
                   ((modeToReset === 'defense' && state.events[i].mode === 'defense') ||
                    (modeToReset === 'attack' && state.events[i].mode === 'attack'))) {
                    
                    const event = state.events[i];
                    
                    if (event.mode === 'defense') {
                        if (event.actionType === 'save') {
                            state.goalkeeperStats.zones[zoneToReset].saves--;
                            state.goalkeeperStats.totalSaves--;
                        } else if (event.actionType === 'goal') {
                            state.goalkeeperStats.zones[zoneToReset].goals--;
                            state.goalkeeperStats.totalGoals--;
                        } else if (event.actionType === 'miss') {
                            state.goalkeeperStats.totalMisses--;
                        }
                    } else {
                        const playerId = event.playerName.replace('Jugador ', '');
                        const playerStats = state.attackersStats.players[playerId];
                        
                        if (playerStats) {
                            playerStats.shots--;
                            
                            if (event.actionType === 'goal') {
                                playerStats.goals--;
                                state.attackersStats.zones[zoneToReset].goals--;
                                state.attackersStats.zones[zoneToReset].shots--;
                            } else if (event.actionType === 'save') {
                                playerStats.saves--;
                                state.attackersStats.zones[zoneToReset].shots--;
                            } else if (event.actionType === 'miss') {
                                playerStats.misses--;
                            }
                        }
                    }
                    
                    state.events.splice(i, 1);
                    updateZoneStats(modeToReset);
                    updateGoalkeeperStats();
                    updatePlayerStats();
                    
                    const zoneDiv = document.querySelector(`#zone-${modeToReset}-${zoneToReset}`);
                    if (zoneDiv) zoneDiv.classList.remove('active-goal', 'active-save', 'active-miss');
                    
                    addEventMessage(`<span style="color: #6b7280"><i class="fas fa-undo"></i> Acción en zona ${zoneToReset} (${modeToReset}) eliminada</span>`);
                    break;
                }
            }
        }
        
        // ---------- GENERACIÓN DE PDF CON GRÁFICAS ----------
        function generatePDF() {
            addEventMessage(`<span style="color: #7c3aed"><i class="fas fa-spinner fa-spin"></i> Generando PDF con gráficas...</span>`);
            
            setTimeout(() => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                // Configuración inicial
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                
                // Título principal
                doc.setFontSize(22);
                doc.setTextColor(40, 53, 147);
                doc.text("REPORTE DE ESTADÍSTICAS DE PORTERÍA", pageWidth / 2, 20, { align: "center" });
                
                doc.setFontSize(12);
                doc.setTextColor(100, 100, 100);
                doc.text("Sistema de Análisis Táctico - Portero vs Ataque", pageWidth / 2, 27, { align: "center" });
                
                // Fecha y hora
                const now = new Date();
                const dateStr = now.toLocaleDateString('es-ES', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                doc.setFontSize(10);
                doc.setTextColor(70, 70, 70);
                doc.text(`Generado el ${dateStr} a las ${timeStr}`, pageWidth / 2, 34, { align: "center" });
                
                // Línea separadora
                doc.setDrawColor(200, 200, 200);
                doc.line(10, 38, pageWidth - 10, 38);
                
                // ============ PRIMERA PÁGINA: RESUMEN Y GRÁFICAS ============
                let yPos = 45;
                
                // Resumen de estadísticas
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text("RESUMEN DE ESTADÍSTICAS", 10, yPos);
                yPos += 10;
                
                doc.setFontSize(11);
                const totalSaves = state.goalkeeperStats.totalSaves;
                const totalGoals = state.goalkeeperStats.totalGoals;
                const totalMisses = state.goalkeeperStats.totalMisses;
                const totalShots = totalSaves + totalGoals;
                const effectiveness = totalShots > 0 ? Math.round((totalSaves / totalShots) * 100) : 0;
                
                // Estadísticas en cuadros
                const statsBoxWidth = 45;
                const statsBoxHeight = 20;
                const statsSpacing = 10;
                
                // Cuadro 1: Paradas
                doc.setFillColor(5, 150, 105);
                doc.roundedRect(10, yPos, statsBoxWidth, statsBoxHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.text(totalSaves.toString(), 10 + statsBoxWidth/2, yPos + 9, { align: "center" });
                doc.setFontSize(8);
                doc.text("PARADAS", 10 + statsBoxWidth/2, yPos + 15, { align: "center" });
                
                // Cuadro 2: Goles recibidos
                doc.setFillColor(220, 38, 38);
                doc.roundedRect(10 + statsBoxWidth + statsSpacing, yPos, statsBoxWidth, statsBoxHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.text(totalGoals.toString(), 10 + statsBoxWidth + statsSpacing + statsBoxWidth/2, yPos + 9, { align: "center" });
                doc.setFontSize(8);
                doc.text("GOLES RECIBIDOS", 10 + statsBoxWidth + statsSpacing + statsBoxWidth/2, yPos + 15, { align: "center" });
                
                // Cuadro 3: Tiros fuera
                doc.setFillColor(245, 158, 11);
                doc.roundedRect(10 + (statsBoxWidth + statsSpacing) * 2, yPos, statsBoxWidth, statsBoxHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.text(totalMisses.toString(), 10 + (statsBoxWidth + statsSpacing) * 2 + statsBoxWidth/2, yPos + 9, { align: "center" });
                doc.setFontSize(8);
                doc.text("TIROS FUERA", 10 + (statsBoxWidth + statsSpacing) * 2 + statsBoxWidth/2, yPos + 15, { align: "center" });
                
                // Cuadro 4: Efectividad
                doc.setFillColor(52, 152, 219);
                doc.roundedRect(10 + (statsBoxWidth + statsSpacing) * 3, yPos, statsBoxWidth, statsBoxHeight, 3, 3, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.text(`${effectiveness}%`, 10 + (statsBoxWidth + statsSpacing) * 3 + statsBoxWidth/2, yPos + 9, { align: "center" });
                doc.setFontSize(8);
                doc.text("EFECTIVIDAD", 10 + (statsBoxWidth + statsSpacing) * 3 + statsBoxWidth/2, yPos + 15, { align: "center" });
                
                yPos += statsBoxHeight + 15;
                
                // ============ GRÁFICAS AUTOMÁTICAS ============
                doc.setFontSize(16);
                doc.setTextColor(0, 0, 0);
                doc.text("GRÁFICAS DE ANÁLISIS", 10, yPos);
                yPos += 8;
                
                // Crear gráficas dinámicamente
                const chartsData = generateChartsData();
                
                // Gráfica 1: Distribución de tiros (Portero)
                const chart1Canvas = createChartCanvas('pie', chartsData.shotsDistribution, 
                    ['Paradas', 'Goles Recibidos', 'Tiros Fuera'], 
                    ['#059669', '#dc2626', '#f59e0b'],
                    'Distribución de Tiros (Portero)');
                
                const chart1Img = chart1Canvas.toDataURL('image/png');
                doc.addImage(chart1Img, 'PNG', 10, yPos, 90, 60);
                
                // Gráfica 2: Efectividad por zona
                const chart2Canvas = createChartCanvas('bar', chartsData.zoneEffectiveness, 
                    chartsData.zoneLabels, ['#3498db'], 'Efectividad por Zona (%)');
                
                const chart2Img = chart2Canvas.toDataURL('image/png');
                doc.addImage(chart2Img, 'PNG', pageWidth - 100, yPos, 90, 60);
                
                yPos += 65;
                
                // Gráfica 3: Rendimiento de jugadores (si hay)
                if (chartsData.playersData.length > 0) {
                    const chart3Canvas = createChartCanvas('horizontalBar', chartsData.playersData, 
                        chartsData.playersLabels, ['#059669'], 'Goles por Jugador');
                    
                    const chart3Img = chart3Canvas.toDataURL('image/png');
                    doc.addImage(chart3Img, 'PNG', 10, yPos, 180, 70);
                    
                    yPos += 75;
                }
                
                // Si no hay espacio, crear nueva página
                if (yPos > pageHeight - 30) {
                    doc.addPage();
                    yPos = 20;
                }
                
                // ============ SEGUNDA SECCIÓN: ESTADÍSTICAS DETALLADAS ============
                doc.setFontSize(16);
                doc.text("ESTADÍSTICAS DETALLADAS POR ZONA", 10, yPos);
                yPos += 10;
                
                // Tabla de zonas del portero
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                
                // Encabezado de tabla
                doc.setFillColor(52, 152, 219);
                doc.rect(10, yPos, pageWidth - 20, 8, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text("Zona", 15, yPos + 6);
                doc.text("Paradas", 50, yPos + 6);
                doc.text("Goles", 85, yPos + 6);
                doc.text("Total", 120, yPos + 6);
                doc.text("Efectividad", 155, yPos + 6);
                
                yPos += 8;
                doc.setTextColor(0, 0, 0);
                
                // Filas de datos
                const zones = ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3'];
                zones.forEach((zone, index) => {
                    const stats = state.goalkeeperStats.zones[zone];
                    const saves = stats.saves || 0;
                    const goals = stats.goals || 0;
                    const total = saves + goals;
                    const eff = total > 0 ? Math.round((saves / total) * 100) : 0;
                    
                    // Fondo alternado
                    if (index % 2 === 0) {
                        doc.setFillColor(240, 240, 240);
                        doc.rect(10, yPos, pageWidth - 20, 6, 'F');
                    }
                    
                    doc.text(zone, 15, yPos + 4.5);
                    doc.text(saves.toString(), 50, yPos + 4.5);
                    doc.text(goals.toString(), 85, yPos + 4.5);
                    doc.text(total.toString(), 120, yPos + 4.5);
                    doc.text(`${eff}%`, 155, yPos + 4.5);
                    
                    yPos += 6;
                });
                
                yPos += 10;
                
                // ============ TERCERA SECCIÓN: JUGADORES ============
                if (state.playerNumbers.length > 0) {
                    if (yPos > pageHeight - 50) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(16);
                    doc.text("ESTADÍSTICAS POR JUGADOR (ATAQUE)", 10, yPos);
                    yPos += 10;
                    
                    // Encabezado de tabla de jugadores
                    doc.setFontSize(10);
                    doc.setFillColor(5, 150, 105);
                    doc.rect(10, yPos, pageWidth - 20, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.text("Jugador", 15, yPos + 6);
                    doc.text("Tiros", 45, yPos + 6);
                    doc.text("Goles", 75, yPos + 6);
                    doc.text("Parados", 105, yPos + 6);
                    doc.text("Fuera", 135, yPos + 6);
                    doc.text("% Acierto", 165, yPos + 6);
                    
                    yPos += 8;
                    doc.setTextColor(0, 0, 0);
                    
                    // Ordenar jugadores
                    const playerIds = state.playerNumbers.sort((a, b) => {
                        const numA = parseInt(a) || 0;
                        const numB = parseInt(b) || 0;
                        return numA - numB;
                    });
                    
                    playerIds.forEach((playerId, index) => {
                        const playerStats = state.attackersStats.players[playerId];
                        if (!playerStats) return;
                        
                        const totalShots = playerStats.shots || 0;
                        const goals = playerStats.goals || 0;
                        const saves = playerStats.saves || 0;
                        const misses = playerStats.misses || 0;
                        const accuracy = totalShots > 0 ? Math.round((goals / totalShots) * 100) : 0;
                        
                        // Fondo alternado
                        if (index % 2 === 0) {
                            doc.setFillColor(240, 240, 240);
                            doc.rect(10, yPos, pageWidth - 20, 6, 'F');
                        }
                        
                        doc.text(playerId, 15, yPos + 4.5);
                        doc.text(totalShots.toString(), 45, yPos + 4.5);
                        doc.text(goals.toString(), 75, yPos + 4.5);
                        doc.text(saves.toString(), 105, yPos + 4.5);
                        doc.text(misses.toString(), 135, yPos + 4.5);
                        doc.text(`${accuracy}%`, 165, yPos + 4.5);
                        
                        yPos += 6;
                    });
                }
                
                // ============ PÁGINA DE EVENTOS ============
                if (state.events.length > 0) {
                    doc.addPage();
                    yPos = 20;
                    
                    doc.setFontSize(16);
                    doc.text("REGISTRO DE EVENTOS DEL PARTIDO", 10, yPos);
                    yPos += 10;
                    
                    doc.setFontSize(10);
                    
                    state.events.forEach((event, index) => {
                        if (yPos > pageHeight - 10) {
                            doc.addPage();
                            yPos = 20;
                        }
                        
                        // Color según tipo de evento
                        let eventColor = [0, 0, 0];
                        if (event.actionType === 'save') eventColor = [5, 150, 105];
                        if (event.actionType === 'goal') eventColor = [220, 38, 38];
                        if (event.actionType === 'miss') eventColor = [245, 158, 11];
                        
                        doc.setTextColor(eventColor[0], eventColor[1], eventColor[2]);
                        doc.text(`[${event.time}] ${event.playerName}: ${event.type}`, 10, yPos);
                        
                        yPos += 7;
                    });
                }
                
                // Pie de página final
                doc.addPage();
                doc.setFontSize(14);
                doc.setTextColor(40, 53, 147);
                doc.text("ANÁLISIS COMPLETO FINALIZADO", pageWidth / 2, pageHeight / 2 - 10, { align: "center" });
                
                doc.setFontSize(11);
                doc.setTextColor(100, 100, 100);
                doc.text("Reporte generado automáticamente por el Sistema de Portería Visual", pageWidth / 2, pageHeight / 2 + 10, { align: "center" });
                
                // Guardar PDF y mostrar vista previa
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                
                // Guardar referencia para descargas posteriores
                state.lastGeneratedPDF = doc;
                state.pdfBlob = pdfBlob;
                
                // Mostrar vista previa
                $("pdf-preview").style.display = "block";
                const pdfViewer = $("pdf-viewer");
                pdfViewer.src = pdfUrl;
                pdfViewer.style.display = "block";
                
                // Desplazar a la vista previa
                $("pdf-preview").scrollIntoView({ behavior: 'smooth' });
                
                addEventMessage(`<span style="color: #7c3aed"><i class="fas fa-check-circle"></i> PDF generado con gráficas automáticas</span>`);
                
            }, 500);
        }
        
        // Función para crear datos de gráficas
        function generateChartsData() {
            const data = {
                shotsDistribution: [
                    state.goalkeeperStats.totalSaves,
                    state.goalkeeperStats.totalGoals,
                    state.goalkeeperStats.totalMisses
                ],
                zoneLabels: ['A1', 'A2', 'A3', 'B1', 'B2', 'B3', 'C1', 'C2', 'C3'],
                zoneEffectiveness: [],
                playersLabels: [],
                playersData: []
            };
            
            // Calcular efectividad por zona
            data.zoneLabels.forEach(zone => {
                const stats = state.goalkeeperStats.zones[zone];
                const total = stats.saves + stats.goals;
                const effectiveness = total > 0 ? Math.round((stats.saves / total) * 100) : 0;
                data.zoneEffectiveness.push(effectiveness);
            });
            
            // Datos de jugadores (solo los que tienen tiros)
            const playerIds = state.playerNumbers.sort((a, b) => {
                const numA = parseInt(a) || 0;
                const numB = parseInt(b) || 0;
                return numA - numB;
            });
            
            playerIds.forEach(playerId => {
                const playerStats = state.attackersStats.players[playerId];
                if (playerStats && playerStats.shots > 0) {
                    data.playersLabels.push(`J${playerId}`);
                    data.playersData.push(playerStats.goals || 0);
                }
            });
            
            return data;
        }
        
        // Función para crear canvas de gráfica
        function createChartCanvas(type, data, labels, colors, title) {
            const canvas = document.createElement('canvas');
            canvas.width = 400;
            canvas.height = 300;
            
            const ctx = canvas.getContext('2d');
            
            // Configurar gráfica según tipo
            let chartConfig = {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(c => c.replace(')', ', 0.8)').replace('rgb', 'rgba')),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        title: {
                            display: true,
                            text: title,
                            font: { size: 14, weight: 'bold' }
                        },
                        legend: {
                            display: type === 'pie',
                            position: 'right'
                        }
                    }
                }
            };
            
            // Configuraciones específicas por tipo
            if (type === 'bar' || type === 'horizontalBar') {
                chartConfig.options.scales = {
                    y: {
                        beginAtZero: true,
                        max: type === 'bar' ? 100 : Math.max(...data) + 2
                    }
                };
            }
            
            new Chart(ctx, chartConfig);
            
            return canvas;
        }
        
        // ---------- FUNCIONALIDAD DE EMAIL ----------
        function showEmailModal() {
            // Generar PDF primero si no hay uno reciente
            if (!state.lastGeneratedPDF) {
                generatePDF();
                setTimeout(showEmailModal, 1000);
                return;
            }
            
            $("email-modal").style.display = "flex";
        }
        
        function sendEmail() {
            const emailTo = $("email-to").value;
            const emailSubject = $("email-subject").value;
            const emailMessage = $("email-message").value;
            
            if (!emailTo || !emailTo.includes('@')) {
                alert('Por favor, introduce un email válido');
                return;
            }
            
            addEventMessage(`<span style="color: #ea580c"><i class="fas fa-spinner fa-spin"></i> Preparando envío de email...</span>`);
            
            // En un entorno real, aquí iría la llamada a un servidor
            // Para este ejemplo, simulamos el envío
            setTimeout(() => {
                // Crear enlace de correo
                const subject = encodeURIComponent(emailSubject);
                const body = encodeURIComponent(`${emailMessage}\n\n---\nAdjunto: Reporte de Estadísticas de Portería\nFecha: ${new Date().toLocaleDateString()}`);
                
                // Simular envío (en realidad abriría el cliente de email)
                const mailtoLink = `mailto:${emailTo}?subject=${subject}&body=${body}`;
                
                // Mostrar opción para abrir cliente de email
                if (confirm(`¿Deseas abrir tu cliente de email para enviar el reporte a ${emailTo}?\n\nNota: Debes adjuntar manualmente el PDF generado.`)) {
                    window.open(mailtoLink, '_blank');
                }
                
                addEventMessage(`<span style="color: #059669"><i class="fas fa-check-circle"></i> Email preparado para ${emailTo}</span>`);
                hideEmailModal();
                
            }, 1500);
        }
        
        function hideEmailModal() {
            $("email-modal").style.display = "none";
            $("email-to").value = "";
            $("email-message").value = "";
        }
        
        function downloadPDF() {
            if (state.lastGeneratedPDF) {
                const dateStr = new Date().toISOString().split('T')[0];
                state.lastGeneratedPDF.save(`porteria_estadisticas_${dateStr}.pdf`);
                addEventMessage(`<span style="color: #059669"><i class="fas fa-download"></i> PDF descargado exitosamente</span>`);
            }
        }
        
        function sharePDF() {
            if (state.pdfBlob && navigator.share) {
                // Compartir usando Web Share API
                const file = new File([state.pdfBlob], `porteria_estadisticas_${new Date().toISOString().split('T')[0]}.pdf`, {
                    type: 'application/pdf'
                });
                
                navigator.share({
                    files: [file],
                    title: 'Estadísticas de Portería',
                    text: 'Reporte completo de estadísticas de portería generado automáticamente'
                })
                .then(() => addEventMessage(`<span style="color: #059669"><i class="fas fa-share-alt"></i> PDF compartido exitosamente</span>`))
                .catch(err => {
                    console.error('Error sharing:', err);
                    // Fallback: descargar
                    downloadPDF();
                });
            } else {
                // Fallback: mostrar opciones de descarga
                downloadPDF();
            }
        }
        
        // ---------- INICIALIZACIÓN ----------
        document.addEventListener("DOMContentLoaded", function() {
            // Crear las porterías visuales
            createGoalVisuals();
            
            // Configurar botones de defensa
            $("save-btn-defense").addEventListener("click", () => registerDefenseAction('save'));
            $("goal-btn-defense").addEventListener("click", () => registerDefenseAction('goal'));
            $("outside-btn-defense").addEventListener("click", () => registerDefenseAction('miss'));
            
            // Configurar botones de ataque
            $("goal-btn-attack").addEventListener("click", () => registerAttackAction('goal'));
            $("save-btn-attack").addEventListener("click", () => registerAttackAction('save'));
            $("outside-btn-attack").addEventListener("click", () => registerAttackAction('miss'));
            
            // Configurar botón de reset
            $("reset-btn").addEventListener("click", resetZoneAction);
            
            // Configurar agregar jugador
            $("add-player-btn").addEventListener("click", addPlayer);
            $("player-number-input").addEventListener("keypress", function(e) {
                if (e.key === 'Enter') addPlayer();
            });
            
            // Configurar botones de PDF
            $("pdf-btn").addEventListener("click", generatePDF);
            $("download-pdf-btn").addEventListener("click", downloadPDF);
            $("share-pdf-btn").addEventListener("click", sharePDF);
            
            // Configurar botón de email
            $("email-btn").addEventListener("click", showEmailModal);
            
            // Configurar modal de email
            $("cancel-email-btn").addEventListener("click", hideEmailModal);
            $("send-email-btn").addEventListener("click", sendEmail);
            
            // Cerrar modal al hacer clic fuera
            $("email-modal").addEventListener("click", function(e) {
                if (e.target === this) hideEmailModal();
            });
            
            // Mensaje inicial
            setTimeout(() => {
                addEventMessage(`<span style="color: #3498db"><i class="fas fa-info-circle"></i> Sistema de Portería Dual iniciado</span>`);
                addEventMessage(`<span style="color: #3498db"><i class="fas fa-info-circle"></i> IZQUIERDA: Defensa (Portero) | DERECHA: Ataque (Jugadores)</span>`);
                addEventMessage(`<span style="color: #3498db"><i class="fas fa-info-circle"></i> Los gráficos se generan automáticamente en el PDF</span>`);
            }, 500);
        });
    </script>
</body>
</html>
